# building.yml
name: Building Docker

# Allow repository modyfication;
#permissions:
#  packages: write

on:
  # Trigger on each tag-push;
  push:
    tags:
      - '*'
jobs:

  # -----------------
  # Prepare
  # -----------------
  prepare:
    name: prepare
    runs-on: ubuntu-latest
    outputs:
      dockerfilepath: ${{ steps.find-dockerfile.outputs.DOCKERFILE_PATH }}
    steps:
      - uses: actions/checkout@v4
      - shell: bash
        name: Find Dockerfile
        id: find-dockerfile
        run: |
          DOCKERFILE_PATH=$(find ${PWD} -name "Dockerfile");
          echo "DOCKERFILE_PATH=${DOCKERFILE_PATH}" >> $GITHUB_OUTPUT

  # -----------------
  # Docker linter
  # -----------------
  hadolint:
     needs: [ prepare ]
     name: "Lint Dockerfile"
     runs-on: ubuntu-latest
     steps:
       - uses: utilizable/github-actions/.github/actions/linting/docker/hadolint@develop
         with:
           file: ${{ needs.prepare.outputs.dockerfilepath }}
  
  # -----------------
  # Building & Pushing to Github registry 
  # -----------------
  github:
    name: "Artifactory Github"
    needs: [ hadolint ]
    runs-on: ubuntu-latest
    steps:
      - uses: utilizable/github-actions/.github/actions/building/docker/github@develop
        with:
          token: ${{ secrets.token || github.token }}
          context: ./build
            #file: ${{ needs.prepare.outputs.dockerfilepath }}
          file: ./build/Dockerfile 
